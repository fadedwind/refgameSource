[gd_scene load_steps=26 format=2]

[ext_resource path="res://icon.png" type="Texture" id=1]
[ext_resource path="res://Assets/Particles/FireParticle2.png" type="Texture" id=2]
[ext_resource path="res://Assets/Noise/FireNoise.png" type="Texture" id=3]

[sub_resource type="Shader" id=46]
code = "shader_type canvas_item;

uniform sampler2D spriteSheet;
uniform float blur : hint_range(0,10) = 5.0;
uniform sampler2D tonemapping;
uniform float numFrames = 1;

varying float lifetime;
varying float animationOffset;

void vertex() {
	lifetime = INSTANCE_CUSTOM.y;
	animationOffset = floor(INSTANCE_CUSTOM.z * numFrames) / numFrames;
}

void fragment() {
	vec2 adjustedUV = UV;
	adjustedUV.x /= numFrames;
	adjustedUV.x += animationOffset;
	float tex = textureLod(spriteSheet, adjustedUV, blur).r;
	vec4 grad = texture(tonemapping, vec2(tex - COLOR.a));
	COLOR = vec4(grad.rgb * COLOR.rgb, grad.a);
} "

[sub_resource type="Gradient" id=64]
interpolation_mode = 1
offsets = PoolRealArray( 0, 0.138462, 0.225641, 0.323077 )
colors = PoolColorArray( 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0.998688, 1, 0.328125, 1 )

[sub_resource type="GradientTexture" id=48]
gradient = SubResource( 64 )

[sub_resource type="ShaderMaterial" id=65]
shader = SubResource( 46 )
shader_param/blur = 0.0
shader_param/numFrames = 1.0
shader_param/spriteSheet = ExtResource( 2 )
shader_param/tonemapping = SubResource( 48 )

[sub_resource type="Gradient" id=66]
offsets = PoolRealArray( 0, 0.312821, 1 )
colors = PoolColorArray( 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1 )

[sub_resource type="GradientTexture" id=63]
gradient = SubResource( 66 )

[sub_resource type="Curve" id=67]
_data = [ Vector2( 0, 0 ), 0.0, 0.728615, 0, 0, Vector2( 1, 0.694318 ), 0.252998, 0.0, 0, 0 ]

[sub_resource type="CurveTexture" id=51]
curve = SubResource( 67 )

[sub_resource type="ParticlesMaterial" id=68]
emission_shape = 1
emission_sphere_radius = 33.79
flag_disable_z = true
gravity = Vector3( 0, -98, 0 )
initial_velocity = 26.79
initial_velocity_random = 1.0
orbit_velocity = 0.0
orbit_velocity_random = 0.0
angle = 720.0
angle_random = 1.0
scale = 9.89
scale_random = 0.54
scale_curve = SubResource( 51 )
color_ramp = SubResource( 63 )

[sub_resource type="Gradient" id=74]
offsets = PoolRealArray( 0, 0.100515, 0.107692, 0.131621, 0.136437, 0.264848, 0.276083, 0.29695, 0.304976, 1 )
colors = PoolColorArray( 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0.141176, 1, 1, 0, 0.141176, 1, 0.118652, 0, 0.0153118, 1, 0.157715, 0.0246429, 0.0454974, 1, 0.981934, 0.406582, 0.51446, 1, 1, 1, 1, 1 )

[sub_resource type="GradientTexture" id=75]
gradient = SubResource( 74 )

[sub_resource type="ShaderMaterial" id=76]
shader = SubResource( 46 )
shader_param/blur = 0.0
shader_param/numFrames = 1.0
shader_param/spriteSheet = ExtResource( 2 )
shader_param/tonemapping = SubResource( 75 )

[sub_resource type="ParticlesMaterial" id=77]
lifetime_randomness = 0.12
emission_shape = 1
emission_sphere_radius = 64.05
flag_disable_z = true
direction = Vector3( 0, -1, 0 )
spread = 29.62
gravity = Vector3( 0, -98, 0 )
initial_velocity = 112.92
initial_velocity_random = 0.67
angular_velocity = 55.9
angular_velocity_random = 1.0
orbit_velocity = 0.0
orbit_velocity_random = 0.0
angle = 720.0
angle_random = 1.0
scale = 9.89
scale_random = 0.54
scale_curve = SubResource( 51 )
color_ramp = SubResource( 63 )

[sub_resource type="Shader" id=53]
code = "shader_type canvas_item;

uniform sampler2D overlapGradient;
uniform sampler2D tex2;
uniform vec2 scroll1 = vec2(0.2, -0.3);
uniform vec2 scroll2 = vec2(0.1, -0.4);
uniform float tex2_scale = 0.5;
uniform float tex1_scale = 1.0;
varying float particleId;
varying float rotationRadians;
varying vec2 scroll1_r;
varying vec2 scroll2_r;


vec2 rotate(vec2 uv, float rotation) {
    float cosa = cos(rotation);
    float sina = sin(rotation);

    return vec2(
        cosa * uv.x - sina * uv.y,
        cosa * uv.y + sina * uv.x 
    ) ;
}

void vertex(){
	particleId = INSTANCE_CUSTOM.z;
	rotationRadians = INSTANCE_CUSTOM.x;
	
	VERTEX.x *= ceil(particleId * 10.0) * 0.05  + 0.6;
	VERTEX.y *= ceil(particleId * 100.0) * 0.005  + 0.6;
	float adjustedTime = INSTANCE_CUSTOM.y + particleId * 11374.293247;
	//scroll1_r =  adjustedTime * scroll1;
	//scroll2_r =  adjustedTime * scroll2;
	scroll1_r =  adjustedTime * rotate(scroll1, rotationRadians );
	scroll2_r =  adjustedTime * rotate(scroll2, rotationRadians );

	
	//VERTEX.x *= rotationRadians * 10.0;
	
}



void fragment() {
	float tex1_intensity = texture(TEXTURE, tex1_scale *(particleId + 0.5)* (UV + scroll1_r)).r;
	float tex2_intensity = texture(tex2, tex2_scale * (UV + scroll2_r)).r;
	float circle = 1.0 - smoothstep(0.3, 0.5, distance(UV, vec2(0.5, 0.5))); 	// 0.3: circle dist start, 0.5 circle dist end
	
	float intensity = tex1_intensity * tex2_intensity * circle ;
	
	//float colorIntensity = (intensity -  (1.0 - COLOR.a)) * 2.0;
	float colorIntensity = intensity * 4.0 * COLOR.a;
	vec4 overlapColor = texture(overlapGradient, vec2(colorIntensity));
	
	//COLOR.a = 1.0;
	//COLOR.a *= min(intensity* 8.0, 1.0); // already used in intensity
	COLOR = overlapColor;

	//COLOR.a *= texture(TEXTURE, UV).a;

}"

[sub_resource type="Gradient" id=69]
interpolation_mode = 1
offsets = PoolRealArray( 0, 0.189744, 0.266667, 0.45641 )
colors = PoolColorArray( 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0.993744, 0.359375, 1 )

[sub_resource type="GradientTexture" id=55]
gradient = SubResource( 69 )

[sub_resource type="ShaderMaterial" id=70]
shader = SubResource( 53 )
shader_param/scroll1 = Vector2( 0.2, 0.406 )
shader_param/scroll2 = Vector2( -0.1552, 0.5911 )
shader_param/tex2_scale = 0.9361
shader_param/tex1_scale = 0.6139
shader_param/overlapGradient = SubResource( 55 )
shader_param/tex2 = ExtResource( 2 )

[sub_resource type="Gradient" id=71]
offsets = PoolRealArray( 0, 0.174359, 0.723077, 1 )
colors = PoolColorArray( 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0.229814, 1, 1, 1, 0 )

[sub_resource type="GradientTexture" id=58]
gradient = SubResource( 71 )

[sub_resource type="Curve" id=72]
max_value = 1.31
_data = [ Vector2( 0, 0 ), 0.0, 0.712059, 0, 0, Vector2( 1, 1.28618 ), 1.28334, 0.0, 0, 0 ]

[sub_resource type="CurveTexture" id=60]
curve = SubResource( 72 )

[sub_resource type="ParticlesMaterial" id=73]
flag_disable_z = true
direction = Vector3( 0, -1, 0 )
spread = 14.88
gravity = Vector3( 0, -98, 0 )
initial_velocity = 98.66
orbit_velocity = 0.0
orbit_velocity_random = 0.0
scale = 0.38
scale_random = 0.25
scale_curve = SubResource( 60 )
color_ramp = SubResource( 58 )
anim_offset = 1.0
anim_offset_random = 1.0

[node name="Node2D" type="Node2D"]

[node name="Particles2D" type="Particles2D" parent="."]
modulate = Color( 2, 2, 2, 1 )
material = SubResource( 65 )
position = Vector2( 340, -378 )
speed_scale = 0.82
local_coords = false
process_material = SubResource( 68 )
texture = ExtResource( 1 )

[node name="Particles2D2" type="Particles2D" parent="."]
modulate = Color( 2, 2, 2, 1 )
material = SubResource( 76 )
position = Vector2( 319, 293 )
speed_scale = 0.84
local_coords = false
process_material = SubResource( 77 )
texture = ExtResource( 1 )

[node name="textureScrolling" type="Particles2D" parent="."]
modulate = Color( 2, 2, 2, 1 )
material = SubResource( 70 )
position = Vector2( 747, -390 )
amount = 7
speed_scale = 0.7
local_coords = false
process_material = SubResource( 73 )
texture = ExtResource( 3 )
